<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDXL // BINARY STREAM</title>
    <style>
        :root { --bg: #000; --panel: #111; --accent: #ff9900; --text: #eee; }
        body { background: var(--bg); color: var(--text); font-family: monospace; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        header { padding: 10px; background: #080808; border-bottom: 1px solid #333; display: flex; justify-content: space-between; }
        .main { display: flex; flex: 1; height: 100%; }
        .viewport { flex: 1; background: #000; display: flex; align-items: center; justify-content: center; }
        img { width: 100%; height: 100%; object-fit: contain; }
        .controls { width: 300px; background: var(--panel); padding: 15px; border-left: 1px solid #333; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        input[type=range], textarea { width: 100%; background: #222; border: 1px solid #444; color: #fff; margin-top: 5px; }
        label { font-size: 0.8rem; color: #888; }
        .stat { color: var(--accent); font-weight: bold; }
    </style>
</head>
<body>

<header>
    <div>SDXL // LIVE</div>
    <div>FPS: <span id="fps_counter" class="stat">0</span></div>
</header>

<div class="main">
    <div class="viewport">
        <img id="live-image" />
    </div>

    <div class="controls">
        <label>Prompt A</label>
        <textarea id="prompt_a">cyberpunk city, neon lights</textarea>

        <label>Mixer <span id="val_mix">0%</span></label>
        <input type="range" id="mix_ratio" min="0" max="1" step="0.01" value="0">
        
        <label>Prompt B</label>
        <textarea id="prompt_b">ancient jungle ruins</textarea>

        <hr style="border-color:#333; width:100%;">

        <label>Zoom</label>
        <input type="range" id="zoom" min="0.9" max="1.1" step="0.001" value="1.0">
        
        <label>Rotate</label>
        <input type="range" id="rotate" min="-5" max="5" step="0.1" value="0.0">
        
        <label>Pan X</label>
        <input type="range" id="pan_x" min="-20" max="20" step="1" value="0">
    </div>
</div>

<script>
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
    
    // CRITICAL: Tell WebSocket to expect RAW DATA
    ws.binaryType = "arraybuffer";

    const imgEl = document.getElementById('live-image');
    const fpsEl = document.getElementById('fps_counter');
    
    // UI Logic
    let state = {
        prompt_a: document.getElementById('prompt_a').value,
        prompt_b: document.getElementById('prompt_b').value,
        mix_ratio: 0.0, strength: 0.5, zoom: 1.0, rotate: 0.0, pan_x: 0, pan_y: 0
    };

    function sendUpdate() {
        if(ws.readyState === 1) ws.send(JSON.stringify(state));
    }

    // FPS Counter Logic
    let frames = 0;
    setInterval(() => { fpsEl.innerText = frames; frames = 0; }, 1000);

    // --- THE BINARY HANDLER ---
    ws.onmessage = (event) => {
        // If it's a Buffer (Image data)
        if (event.data instanceof ArrayBuffer) {
            // Create a Blob from the bytes
            const blob = new Blob([event.data], {type: "image/jpeg"});
            
            // Create a temporary URL for this blob
            const url = URL.createObjectURL(blob);
            
            // Clean up the memory of the PREVIOUS frame
            if (imgEl.src) URL.revokeObjectURL(imgEl.src);
            
            // Update the Image
            imgEl.src = url;
            
            frames++;
        }
    };

    // Bind Controls
    ['prompt_a', 'prompt_b'].forEach(id => {
        document.getElementById(id).addEventListener('input', (e) => {
            state[id] = e.target.value; sendUpdate();
        });
    });

    ['mix_ratio', 'zoom', 'rotate', 'pan_x'].forEach(id => {
        document.getElementById(id).addEventListener('input', (e) => {
            state[id] = parseFloat(e.target.value);
            if(id === 'mix_ratio') document.getElementById('val_mix').innerText = Math.round(state[id]*100) + '%';
            sendUpdate();
        });
    });

</script>
</body>
</html>
